<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Menu</title>
    <style>
      :root {
        --page-gap: 14px;
      }
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: #f5f5f5;
      }
      #viewer {
        padding: var(--page-gap);
        max-width: 1100px;
        margin: 0 auto;
      }
      .page {
        background: white;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        margin: 0 0 var(--page-gap) 0;
        overflow: hidden;
      }
      canvas {
        display: block;
        width: 100%;
        height: auto;
      }
      .error {
        color: #b00020;
        padding: 14px;
        background: #fff;
        border-radius: 12px;
      }
      a {
        color: inherit;
      }
      button {
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 10px;
        padding: 8px 10px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <main id="viewer"></main>

    <script type="module">
      import * as pdfjsLib from "https://unpkg.com/pdfjs-dist@5.4.530/build/pdf.mjs";

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://unpkg.com/pdfjs-dist@5.4.530/build/pdf.worker.mjs";

      const url = "./menu.pdf";
      const viewer = document.getElementById("viewer");

      let pdf = null;
      let rendering = false;

      function clearViewer() {
        viewer.innerHTML = "";
      }

      function showError(msg, err) {
        console.error(err || msg);
        viewer.innerHTML = `<div class="error"><strong>Erreur :</strong> ${msg}</div>`;
      }

      function getScaleForPage(page) {
        const containerWidth = Math.min(viewer.clientWidth, 1100) - 0;
        const viewportAt1 = page.getViewport({ scale: 1 });
        const scale = containerWidth / viewportAt1.width;
        return Math.max(scale, 1);
      }

      async function renderAllPages() {
        if (!pdf || rendering) return;
        rendering = true;

        try {
          clearViewer();

          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const scale = getScaleForPage(page);
            const viewport = page.getViewport({ scale });

            const pageWrap = document.createElement("div");
            pageWrap.className = "page";

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d", { alpha: false });

            canvas.width = Math.floor(viewport.width);
            canvas.height = Math.floor(viewport.height);

            pageWrap.appendChild(canvas);
            viewer.appendChild(pageWrap);

            await page.render({ canvasContext: ctx, viewport }).promise;
          }
        } catch (err) {
          showError("Impossible dâ€™afficher le PDF.", err);
        } finally {
          rendering = false;
        }
      }

      function debounce(fn, delay = 250) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), delay);
        };
      }

      async function init() {
        try {
          pdf = await pdfjsLib.getDocument({ url }).promise;
          await renderAllPages();
        } catch (err) {
          showError("Chargement du PDF impossible.", err);
        }
      }

      window.addEventListener(
        "resize",
        debounce(() => renderAllPages(), 350),
      );

      init();
    </script>
  </body>
</html>
